---
title: "Project"
author: "anonymous"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r, warning=FALSE, results="hide", message=FALSE}
library(ggplot2)
library(posterior)
library(bayesplot)
library(rstan)
library(tidyr)
library(dplyr)
library(ggcorrplot)
library(gridExtra)
library(plyr)
library(loo)
```

```{r}
set.seed(123)

credit_risk <- read.csv(file="german_credit_data.csv")

summary(credit_risk)
```

```{r}
credit_risk <- subset(credit_risk, select=-c(`X`))
```

```{r}
miss <- function(x){sum(is.na(x))/length(x)*100}
apply(credit_risk, 2, miss)
```



```{r}
get_mode <- function(x) {
  ux <- unique(x)
  ux <- na.omit(ux)
  ux[which.max(tabulate(match(x, ux)))]
}

credit_risk$`Saving.accounts`[is.na(credit_risk$`Saving.accounts`)] <- get_mode(credit_risk$`Saving.accounts`)
credit_risk$`Checking.account`[is.na(credit_risk$`Checking.account`)] <- get_mode(credit_risk$`Checking.account`)

miss <- function(x){sum(is.na(x))/length(x)*100}
apply(credit_risk, 2, miss)
```

```{r}
ggplot(credit_risk, aes(x=Age, fill=Risk)) +
  geom_histogram()
```
```{r}
ggplot(credit_risk, aes(x=Sex, fill=Risk)) +
  geom_bar()
```
```{r}
ggplot(credit_risk, aes(x=Job, fill=Risk)) +
  geom_bar()
```
```{r}
ggplot(credit_risk, aes(x=Housing, fill=Risk)) +
  geom_bar()
```

```{r}
ggplot(credit_risk, aes(x=Saving.accounts, fill=Risk)) +
  geom_bar()
```
```{r}
credit_risk$Saving.accounts <- plyr::mapvalues(credit_risk$Saving.accounts, 
                                         from =c("little","moderate","quite rich","rich"), 
                                         to = c("little","moderate","rich","rich"))
```

```{r}
ggplot(credit_risk, aes(x=Saving.accounts, fill=Risk)) +
  geom_bar()
```


```{r}
ggplot(credit_risk, aes(x=Checking.account, fill=Risk)) +
  geom_bar()
```

```{r}
ggplot(credit_risk, aes(x=Credit.amount, fill=Risk)) +
  geom_histogram()
```

```{r}
credit_risk <- credit_risk[credit_risk$Credit.amount < 10000,]
```

```{r}
ggplot(credit_risk, aes(x=Credit.amount, fill=Risk)) +
  geom_histogram()
```

```{r}
ggplot(credit_risk, aes(x=Duration, fill=Risk)) +
  geom_histogram()
```

```{r}
credit_risk <- credit_risk[credit_risk$Duration < max(credit_risk$Duration),]
```

```{r}
ggplot(credit_risk, aes(x=Duration, fill=Risk)) +
  geom_histogram()
```

```{r}
ggplot(credit_risk, aes(x=Purpose, fill=Risk)) +
  geom_bar()
```

```{r}
credit_risk$Purpose <- plyr::mapvalues(credit_risk$Purpose,
                                       from = c("business","car","domestic appliances",
                                      "education","furniture/equipment","radio/TV","repairs","vacation/others"), 
                                      to = c("business","car","furniture/equipment","education",
                                             "furniture/equipment","radio/TV","others","others")) 
```

```{r}
ggplot(credit_risk, aes(x=Purpose, fill=Risk)) +
  geom_bar()
```

```{r}
# Convert data into numerical data
credit_risk$Sex = as.numeric(factor(credit_risk$Sex))
credit_risk$Housing = as.numeric(factor(credit_risk$Housing))
credit_risk$Saving.accounts = as.numeric(factor(credit_risk$Saving.accounts))
credit_risk$Checking.account = as.numeric(factor(credit_risk$Checking.account))
credit_risk$Purpose = as.numeric(factor(credit_risk$Purpose))
credit_risk$Risk = as.numeric(factor(credit_risk$Risk)) - 1

ggcorrplot(cor(credit_risk), lab = TRUE, lab_size = 3)
```



```{r}
credit_risk <- credit_risk[sample(nrow(credit_risk)), ]
# Standardize data
data_non_hierarchical <- credit_risk %>% mutate_at(colnames(credit_risk)[!colnames(credit_risk) %in% c("Risk")], ~(scale(.) %>% as.vector))
data_hierarchical <- credit_risk %>% mutate_at(colnames(credit_risk)[!colnames(credit_risk) %in% c("Risk", "Purpose")], ~(scale(.) %>% as.vector))
```

```{r}
train_size <- round(nrow(data_non_hierarchical)/2, 0)
test_size <- nrow(data_non_hierarchical) - train_size
train_size/test_size
```

```{r}
data_train <- head(data_non_hierarchical, train_size)
data_test <- tail(data_non_hierarchical, test_size)

y_train_non_hierarchical = data_train$Risk
y_test_non_hierarchical = data_test$Risk

X_train_non_hierarchical = subset(data_train, select=-c(`Risk`)) 
X_test_non_hierarchical = subset(data_test, select=-c(`Risk`)) 

credit_data <- list(N_train=nrow(X_train_non_hierarchical), 
                    D=ncol(X_train_non_hierarchical), 
                    X_train=X_train_non_hierarchical, 
                    y_train=y_train_non_hierarchical,
                    N_test=nrow(X_test_non_hierarchical),
                    X_test=X_test_non_hierarchical)

non_hierarchical_fit <- stan(file="non-hierarchical.stan", data=credit_data, chains=4, iter=2000, warmup=1000)
```

```{r}
data_train <- head(data_hierarchical, train_size)
data_test <- tail(data_hierarchical, test_size)

y_train_hierarchical = data_train$Risk
y_test_hierarchical = data_test$Risk

X_train_hierarchical = subset(data_train, select=-c(`Risk`, `Purpose`)) 
X_test_hierarchical = subset(data_test, select=-c(`Risk`, `Purpose`)) 

ll_train = data_train$Purpose
ll_test = data_test$Purpose

credit_data <- list(N_train=nrow(X_train_hierarchical), 
                    D=ncol(X_train_hierarchical), 
                    L_train=length(unique(ll_train)),
                    ll_train=ll_train,
                    X_train=X_train_hierarchical, 
                    y_train=y_train_hierarchical,
                    N_test=nrow(X_test_hierarchical),
                    L_test=length(unique(ll_test)),
                    ll_test=ll_test,
                    X_test=X_test_hierarchical)

hierarchical_fit <- stan(file="hierarchical.stan", data=credit_data, chains=4, iter=2000, warmup=1000)
```

Rhat
```{r}
r_hat = summary(non_hierarchical_fit)$summary[,"Rhat"]
ggplot(data=as.data.frame(r_hat)) +
  geom_histogram(aes(x=`r_hat`))
```

```{r}
mcmc_neff(neff_ratio(non_hierarchical_fit))

mcmc_neff(neff_ratio(hierarchical_fit))
```

```{r}
r_hat = summary(hierarchical_fit)$summary[,"Rhat"]
ggplot(data=as.data.frame(r_hat)) +
  geom_histogram(aes(x=`r_hat`)) 

```

```{r}
non_hierarchical_loo <- loo(non_hierarchical_fit)
hierarchical_loo <- loo(hierarchical_fit)

ggplot() +
  geom_point(aes(x=1:length(hierarchical_loo$diagnostics$pareto_k), y=hierarchical_loo$diagnostics$pareto_k)) +
  scale_x_continuous(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0), limits=c(min(0, min(hierarchical_loo$diagnostics$pareto_k)), 1), n.breaks=6) +
  geom_abline(slope=0, intercept=0.7, linetype="dashed", color="red") +
  geom_abline(slope=0, intercept=0.5, linetype="dashed", color="red") +
  labs(x="Data point", y="Pareto K value", title="Hierarchical model diagnostics") +
  theme(plot.title = element_text(hjust = 0.5)) 

ggplot() +
  geom_point(aes(x=1:length(non_hierarchical_loo$diagnostics$pareto_k), y=non_hierarchical_loo$diagnostics$pareto_k)) +
  scale_x_continuous(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0), limits=c(min(0, min(non_hierarchical_loo$diagnostics$pareto_k)), 1), n.breaks=6) +
  geom_abline(slope=0, intercept=0.7, linetype="dashed", color="red") +
  geom_abline(slope=0, intercept=0.5, linetype="dashed", color="red") +
  labs(x="Data point", y="Pareto K value", title="Non hierarchical model diagnostics") +
  theme(plot.title = element_text(hjust = 0.5)) 
```

```{r}
loo_compare(non_hierarchical_loo, hierarchical_loo)
```

Posterior predictive check
```{r}
# Extract fit
ypred_non_hierarchical <- as.matrix(non_hierarchical_fit, pars="y_pred")
ypred_hierarchical <- as.matrix(hierarchical_fit, pars="y_pred")

ppc_dens_overlay(y_test_non_hierarchical, ypred_non_hierarchical[1:50, ])
ppc_hist(y_test_non_hierarchical, ypred_non_hierarchical[1:5, ])

ppc_dens_overlay(y_test_hierarchical, ypred_hierarchical[1:50, ])
ppc_hist(y_test_hierarchical, ypred_hierarchical[1:5, ])
```

```{r}
confusion_matrix <- function(predictions, actual) {
  true_pos_count <- 0
  true_neg_count <- 0
  false_neg_count <- 0
  false_pos_count <- 0
  for(i in 1:ncol(predictions)) {
    label = paste(c("y_pred[",i,"]"), collapse="")
    predict = mean(predictions[ , label])
    if(predict >= 0.5 && actual[i] == 1) 
      true_pos_count <- true_pos_count + 1 
    else if(predict >= 0.5 && actual[i] == 0) 
      false_pos_count <- false_pos_count + 1
    else if(predict < 0.5 && actual[i] == 0) 
      true_neg_count <- true_neg_count + 1 
    else if(predict < 0.5 && actual[i] == 1) 
      false_neg_count <- false_neg_count + 1 
  }
  matrix(c(true_pos_count, false_pos_count, false_neg_count, true_neg_count), nrow=2, dimnames=list(c("Predicted True", "Predicted False"), c("Actual True", "Actual False")))
}

non_hierarchical_conf_mat <- confusion_matrix(ypred_non_hierarchical, y_test_non_hierarchical)
hierarchical_conf_mat <- confusion_matrix(ypred_hierarchical, y_test_hierarchical)

non_hierarchical_conf_mat
hierarchical_conf_mat
```

Accuracy
```{r}
(non_hierarchical_conf_mat[1,1] + non_hierarchical_conf_mat[2, 2]) / 
  (non_hierarchical_conf_mat[1,1] + non_hierarchical_conf_mat[2, 2] + non_hierarchical_conf_mat[1,2] + non_hierarchical_conf_mat[2, 1])

(hierarchical_conf_mat[1,1] + hierarchical_conf_mat[2, 2]) / 
  (hierarchical_conf_mat[1,1] + hierarchical_conf_mat[2, 2] + hierarchical_conf_mat[1,2] + hierarchical_conf_mat[2, 1])
```

False negative
```{r}
non_hierarchical_conf_mat[2,1]/ 
  (non_hierarchical_conf_mat[1, 1] + non_hierarchical_conf_mat[2,1])

hierarchical_conf_mat[2,1]/ 
  (hierarchical_conf_mat[1, 1] + hierarchical_conf_mat[2,1])
```



















