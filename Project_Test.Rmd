---
title: "Project"
author: "anonymous"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r, warning=FALSE, results="hide", message=FALSE}
library(aaltobda)
library(cmdstanr)
library(ggplot2)
library(posterior)
library(bayesplot)
library(rstan)
library(tidyr)
library(dplyr)
library(gridExtra)
library(loo)
```

```{r}
credit_risk <- read.csv(file="german_credit_data.csv")

summary(credit_risk)
```

```{r}
miss <- function(x){sum(is.na(x))/length(x)*100}
apply(credit_risk, 2, miss)
```

```{r}
get_mode <- function(x) {
  ux <- unique(x)
  ux <- na.omit(ux)
  ux[which.max(tabulate(match(x, ux)))]
}

credit_risk$`Saving.accounts`[is.na(credit_risk$`Saving.accounts`)] <- get_mode(credit_risk$`Saving.accounts`)
credit_risk$`Checking.account`[is.na(credit_risk$`Checking.account`)] <- get_mode(credit_risk$`Checking.account`)

miss <- function(x){sum(is.na(x))/length(x)*100}
apply(credit_risk, 2, miss)
```

```{r}

credit_risk_train <- head(credit_risk, 500)
credit_risk_test <- tail(credit_risk, 500)

y_train = as.numeric(factor(credit_risk_train$Risk)) - 1
y_test = as.numeric(factor(credit_risk_test$Risk)) - 1

X_train = subset(credit_risk_train, select=-c(`X`, `Risk`)) 
X_test = subset(credit_risk_test, select=-c(`X`, `Risk`)) 

credit_data <- list(N_train=nrow(X_train), 
                    J=ncol(X_train), 
                    X_train=X_train, 
                    y_train=y_train,
                    N_test=nrow(X_test),
                    X_test=X_test,
                    y_test=y_test)

fit <- stan(file="test.stan", data=credit_data, chains=4, warmup=1000, iter=2000)
```

Rhat
```{r}
r_hat = summary(fit)$summary[,"Rhat"]
ggplot(data=as.data.frame(r_hat)) +
  geom_histogram(aes(x=`r_hat`))
```
```{r}
mcmc_neff(neff_ratio(fit))
```

Posterior predictive check
```{r}
ypred <- as.matrix(fit, pars="y_pred")
ppc_dens_overlay(y_test, ypred[1:50, ])
ppc_hist(y_test, ypred[1:5, ])
```




